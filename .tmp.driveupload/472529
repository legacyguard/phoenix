var e=Object.defineProperty,s=Object.defineProperties,a=Object.getOwnPropertyDescriptors,r=Object.getOwnPropertySymbols,c=Object.prototype.hasOwnProperty,t=Object.prototype.propertyIsEnumerable,i=(s,a,r)=>a in s?e(s,a,{enumerable:!0,configurable:!0,writable:!0,value:r}):s[a]=r,n=(e,s,a)=>new Promise((r,c)=>{var t=e=>{try{n(a.next(e))}catch(s){c(s)}},i=e=>{try{n(a.throw(e))}catch(s){c(s)}},n=e=>e.done?r(e.value):Promise.resolve(e.value).then(t,i);n((a=a.apply(e,s)).next())});import{j as l}from"./vendor-ui-DOX-GngI.js";import{u as d,r as m}from"./vendor-react-BsuoGMue.js";import{c as o,A as x,i as u,a4 as h,n as j,h as p,a5 as g,H as N,t as f,N as y,C as w,a as v,e as b,S as V,B as _,a1 as k,D as S,a6 as A,T as C,v as O,w as I,x as D,J as T,L as E,a3 as P,b as L,Z as z,d as R,a7 as B,U as J,r as q}from"./index-Co25CVR3.js";import{S as M}from"./skeleton-CEBCh0Mn.js";import{C as W}from"./checkbox-vfIqPBNs.js";import{T as F}from"./textarea-DvJ_jMWI.js";import{s as U}from"./supabaseWithRetry-Cm5ZSG7b.js";import{u as Z}from"./vendor-i18n-C5HfoztV.js";import{A as G}from"./arrow-left-DaFlGroI.js";import{S as Y}from"./star-2FbHlIR4.js";import{C as H}from"./calendar-D4lLPC52.js";import{P as X}from"./phone-CASw_iL6.js";import{H as $}from"./heart-BPRJ7DTV.js";import{C as Q}from"./clock-C7EaDSNX.js";import"./vendor-auth-CQQWOfx5.js";import"./vendor-supabase-DjxWZ-e5.js";import"./vendor-utils-DZ4dNBww.js";
/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const K=o("PhoneCall",[["path",{d:"M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z",key:"foiqr5"}],["path",{d:"M14.05 2a9 9 0 0 1 8 7.94",key:"vmijpz"}],["path",{d:"M14.05 6A5 5 0 0 1 18 10",key:"13nbpp"}]]),ee=({error:e,onRetry:s,showHomeButton:a=!0,showBackButton:r=!0,customMessage:c,className:t=""})=>{const{t:i}=Z(),n=d();if(!e)return null;return l.jsx("div",{className:`flex items-center justify-center min-h-[400px] p-4 ${t}`,children:l.jsxs("div",{className:"max-w-md w-full space-y-4",children:[l.jsxs(x,{variant:"destructive",children:[l.jsx(u,{className:"h-4 w-4"}),l.jsx(h,{children:i("common.error")}),l.jsx(j,{children:c||(e.message.includes("network")?i("errors.networkError"):e.message.includes("permission")?i("errors.permissionDenied"):e.message.includes("not found")?i("errors.dataNotFound"):i("errors.unknown"))})]}),l.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[s&&l.jsxs(p,{variant:"default",onClick:s,className:"flex-1",children:[l.jsx(g,{className:"mr-2 h-4 w-4"}),i("common.retry")]}),r&&l.jsxs(p,{variant:"outline",onClick:()=>n(-1),className:"flex-1",children:[l.jsx(G,{className:"mr-2 h-4 w-4"}),i("common.goBack")]}),a&&l.jsxs(p,{variant:"outline",onClick:()=>n("/dashboard"),className:"flex-1",children:[l.jsx(N,{className:"mr-2 h-4 w-4"}),i("common.goHome")]})]}),!1]})})},se=()=>{const{t:e}=Z("common"),[d,o]=m.useState([]),[x,u]=m.useState([]),[h,j]=m.useState(null),[g,N]=m.useState(!0),[G,se]=m.useState(null),[ae,re]=m.useState(""),[ce,te]=m.useState(null),[ie,ne]=m.useState(!1),[le,de]=m.useState(!1),[me,oe]=m.useState(""),[xe,ue]=m.useState([]),[he,je]=m.useState(!1),[pe,ge]=m.useState(!1),[Ne,fe]=m.useState(""),ye=m.useCallback(()=>n(void 0,null,function*(){try{const{data:{user:s}}=yield U.auth.getUser();if(!s)return void f.error(e("guardianView.errors.pleaseLogin"));const{data:a,error:r}=yield U.from("documents").select("*").eq("is_key_document",!0);r||o(a||[]);const{data:c,error:t}=yield U.from("contacts").select("*");t||u(c||[]);const{data:i,error:n}=yield U.from("instructions").select("*").single();n&&"PGRST116"!==n.code||j(i),re(e("guardianView.defaultUserName"))}catch(s){(new Date).toISOString();const a=s instanceof Error?s.message:e("errors.unknown"),r=s instanceof Error&&"code"in s?String(s.code):"UNKNOWN_ERROR";let c=e("guardianView.errors.failedToLoad");"PGRST116"===r?c=e("errors.dataNotFound"):(null==a?void 0:a.includes("network"))?c=e("errors.networkError"):(null==a?void 0:a.includes("permission"))?c=e("errors.permissionDenied"):(null==a?void 0:a.includes("duplicate"))&&(c=e("errors.duplicateRecord")),te(s instanceof Error?s:new Error(a)),f.error(c)}finally{N(!1)}}),[e]);m.useEffect(()=>{ye()},[ye]);const we=e=>{const s=Object.values(B).find(s=>s.code===e);return(null==s?void 0:s.flag)||"🏳️"},ve=l=>n(void 0,null,function*(){try{const{error:n}=yield U.from("emergency_contacts").update({last_contacted:(new Date).toISOString()}).eq("contact_id",l).eq("user_id",Ne);n||(ue(e=>e.map(e=>{return e.contact_id===l?(n=((e,s)=>{for(var a in s||(s={}))c.call(s,a)&&i(e,a,s[a]);if(r)for(var a of r(s))t.call(s,a)&&i(e,a,s[a]);return e})({},e),d={last_contacted:(new Date).toISOString()},s(n,a(d))):e;var n,d})),f.success(e("guardianView.emergencyAccess.contactLogged")))}catch(n){}});return g?l.jsx(y,{children:l.jsxs("div",{className:"container mx-auto px-4 lg:px-8 py-8 space-y-8",children:[l.jsxs("div",{className:"text-center space-y-4",children:[l.jsx(M,{className:"w-20 h-20 rounded-full mx-auto"}),l.jsxs("div",{className:"space-y-2",children:[l.jsx(M,{className:"h-8 w-64 mx-auto"}),l.jsx(M,{className:"h-4 w-96 mx-auto"})]}),l.jsx(M,{className:"h-6 w-32 mx-auto"})]}),l.jsxs(w,{children:[l.jsxs(v,{children:[l.jsx(M,{className:"h-6 w-48"}),l.jsx(M,{className:"h-4 w-64"})]}),l.jsx(b,{children:l.jsx("div",{className:"space-y-3",children:[1,2,3].map(e=>l.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg",children:[l.jsxs("div",{className:"flex items-center space-x-3",children:[l.jsx(M,{className:"h-4 w-4"}),l.jsxs("div",{className:"space-y-2",children:[l.jsx(M,{className:"h-4 w-32"}),l.jsx(M,{className:"h-3 w-48"})]})]}),l.jsxs("div",{className:"space-y-1",children:[l.jsx(M,{className:"h-4 w-20"}),l.jsx(M,{className:"h-3 w-24"})]})]},e))})})]}),l.jsxs(w,{children:[l.jsxs(v,{children:[l.jsx(M,{className:"h-6 w-48"}),l.jsx(M,{className:"h-4 w-64"})]}),l.jsx(b,{children:l.jsx("div",{className:"space-y-3",children:[1,2].map(e=>l.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg",children:[l.jsxs("div",{className:"flex items-center space-x-3",children:[l.jsx(M,{className:"h-8 w-8 rounded-full"}),l.jsxs("div",{className:"space-y-1",children:[l.jsx(M,{className:"h-4 w-32"}),l.jsx(M,{className:"h-3 w-24"})]})]}),l.jsxs("div",{className:"space-y-1",children:[l.jsx(M,{className:"h-3 w-36"}),l.jsx(M,{className:"h-3 w-28"})]})]},e))})})]}),l.jsxs(w,{children:[l.jsxs(v,{children:[l.jsx(M,{className:"h-6 w-56"}),l.jsx(M,{className:"h-4 w-64"})]}),l.jsx(b,{children:l.jsxs("div",{className:"space-y-4",children:[l.jsxs("div",{className:"space-y-2",children:[l.jsx(M,{className:"h-5 w-32"}),l.jsx(M,{className:"h-20 w-full rounded-lg"})]}),l.jsxs("div",{className:"space-y-2",children:[l.jsx(M,{className:"h-5 w-40"}),l.jsx(M,{className:"h-20 w-full rounded-lg"})]})]})})]})]})}):ce?l.jsx(y,{children:l.jsx(ee,{error:ce,onRetry:()=>{te(null),N(!0),ye()}})}):l.jsxs("div",{className:"container mx-auto px-4 lg:px-8 py-8 space-y-8",children:[l.jsxs("div",{className:"text-center space-y-4",children:[l.jsx("div",{className:"flex items-center justify-center w-20 h-20 rounded-full bg-primary/10 mx-auto",children:l.jsx(V,{className:"h-10 w-10 text-primary"})}),l.jsxs("div",{children:[l.jsx("h1",{className:"text-3xl font-bold",children:e("guardianView.title")}),l.jsx("p",{className:"text-muted-foreground",children:e("guardianView.subtitle",{userName:ae})})]}),l.jsxs("div",{className:"flex items-center justify-center gap-4",children:[l.jsxs(_,{variant:"heritage",children:[l.jsx(k,{className:"h-3 w-3 mr-1"}),e("guardianView.readOnlyAccess")]}),l.jsxs(S,{open:ie,onOpenChange:ne,children:[l.jsx(A,{asChild:!0,children:l.jsxs(p,{variant:"destructive",size:"lg",className:"gap-2",children:[l.jsx(C,{className:"h-5 w-5"}),e("guardianView.emergencyAccess.button")]})}),l.jsxs(O,{className:"sm:max-w-[500px]",children:[l.jsxs(I,{children:[l.jsxs(D,{className:"flex items-center gap-2 text-destructive",children:[l.jsx(C,{className:"h-5 w-5"}),e("guardianView.emergencyAccess.modalTitle")]}),l.jsxs(T,{className:"space-y-2",children:[l.jsx("p",{children:e("guardianView.emergencyAccess.modalDescription")}),l.jsx("p",{className:"text-sm font-medium text-destructive",children:e("guardianView.emergencyAccess.warningText")})]})]}),l.jsxs("div",{className:"space-y-4 py-4",children:[l.jsxs("div",{className:"space-y-2",children:[l.jsx(E,{htmlFor:"emergency-notes",children:e("guardianView.emergencyAccess.reasonLabel")}),l.jsx(F,{id:"emergency-notes",placeholder:e("guardianView.emergencyAccess.reasonPlaceholder"),value:me,onChange:e=>oe(e.target.value),className:"min-h-[100px]"})]}),l.jsxs("div",{className:"flex items-start space-x-2",children:[l.jsx(W,{id:"emergency-confirm",checked:le,onCheckedChange:e=>de(e)}),l.jsx(E,{htmlFor:"emergency-confirm",className:"text-sm font-medium leading-normal cursor-pointer",children:e("guardianView.emergencyAccess.confirmCheckbox")})]})]}),l.jsxs(P,{children:[l.jsx(p,{variant:"outline",onClick:()=>{ne(!1),de(!1),oe("")},children:e("common.cancel")}),l.jsx(p,{variant:"destructive",onClick:()=>n(void 0,null,function*(){if(le&&me.trim()){je(!0);try{const{data:{user:a}}=yield U.auth.getUser();if(!a)return void f.error(e("guardianView.errors.pleaseLogin"));const{data:r,error:c}=yield U.from("guardians").select("id, user_id").eq("guardian_email",a.email).eq("status","accepted").single();if(c||!r)return void f.error(e("guardianView.emergencyAccess.notAuthorized"));const{data:t,error:i}=yield U.from("emergency_contacts").select("\n          *,\n          contact:contacts(*)\n        ").eq("user_id",r.user_id).order("priority_order");if(i)return void f.error(e("guardianView.emergencyAccess.failedToLoadContacts"));ue(t||[]),fe(r.user_id);const n=(t||[]).map(e=>e.contact_id),{error:l}=yield U.from("emergency_access_logs").insert({guardian_id:r.id,user_id:r.user_id,contacts_accessed:n,notes:me});ne(!1),ge(!0);try{const{data:{user:e}}=yield U.auth.getUser(),s=r.guardian_name||(null==e?void 0:e.email)||"Guardian",c=yield fetch("https://zdcbfsyegttwpfrfjkfn.supabase.co/functions/v1/send-emergency-notification",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpkY2Jmc3llZ3R0d3BmcmZqa2ZuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMyODc2NzksImV4cCI6MjA2ODg2MzY3OX0.Vqh96lNh9T18vjjfteCs9fEwNufBYZ5J6fTROGTwYwA"},body:JSON.stringify({userId:r.user_id,guardianId:r.id,guardianName:s,guardianEmail:a.email||"",emergencyNotes:me,timestamp:(new Date).toISOString()})});if(c.ok){yield c.json()}}catch(s){}f.success(e("guardianView.emergencyAccess.accessGranted"))}catch(a){f.error(e("guardianView.emergencyAccess.accessFailed"))}finally{je(!1)}}else f.error(e("guardianView.emergencyAccess.pleaseConfirm"))}),disabled:!le||!me.trim()||he,children:he?l.jsxs(l.Fragment,{children:[l.jsx("span",{className:"animate-spin mr-2",children:"⚡"}),e("guardianView.emergencyAccess.accessing")]}):e("guardianView.emergencyAccess.confirmButton")})]})]})]})]})]}),l.jsxs(w,{variant:"heritage",children:[l.jsxs(v,{children:[l.jsxs(L,{className:"flex items-center",children:[l.jsx(z,{className:"h-5 w-5 mr-2"}),e("guardianView.sections.keyDocuments.title")]}),l.jsx(R,{children:e("guardianView.sections.keyDocuments.description")})]}),l.jsx(b,{children:l.jsx("div",{className:"space-y-3",children:d.length>0?d.map(s=>{var a,r;return l.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg",children:[l.jsxs("div",{className:"flex items-center space-x-3",children:[l.jsx(z,{className:"h-4 w-4 text-primary"}),l.jsxs("div",{children:[l.jsx("h4",{className:"font-medium",children:s.name}),l.jsxs("div",{className:"flex items-center space-x-2 text-sm text-muted-foreground",children:[l.jsx("span",{children:s.type}),l.jsx("span",{children:"•"}),l.jsxs("span",{className:"flex items-center",children:[we(s.country_code),l.jsx("span",{className:"ml-1",children:null==(a=B[s.country_code])?void 0:a.name})]})]})]})]}),l.jsxs("div",{className:"text-right space-y-1",children:[l.jsxs(_,{variant:"secondary",className:"text-xs",children:[l.jsx(Y,{className:"h-3 w-3 mr-1"}),e("guardianView.sections.keyDocuments.keyDocumentBadge")]}),l.jsxs("p",{className:"text-xs text-muted-foreground",children:[l.jsx(H,{className:"h-3 w-3 inline mr-1"}),e("guardianView.sections.keyDocuments.expires"),": ",(r=s.expiration_date,r?new Date(r).toLocaleDateString():e("guardianView.sections.keyDocuments.noExpiration"))]})]})]},s.id)}):l.jsx("p",{className:"text-center text-muted-foreground py-8",children:e("guardianView.sections.keyDocuments.empty")})})})]}),l.jsxs(w,{variant:"earth",children:[l.jsxs(v,{children:[l.jsxs(L,{className:"flex items-center",children:[l.jsx(J,{className:"h-5 w-5 mr-2"}),e("guardianView.sections.importantContacts.title")]}),l.jsx(R,{children:e("guardianView.sections.importantContacts.description")})]}),l.jsx(b,{children:l.jsx("div",{className:"space-y-3",children:x.length>0?x.map(e=>l.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg",children:[l.jsxs("div",{className:"flex items-center space-x-3",children:[l.jsx("div",{className:"flex items-center justify-center w-8 h-8 rounded-full bg-primary/10",children:l.jsx(J,{className:"h-4 w-4 text-primary"})}),l.jsxs("div",{children:[l.jsx("h4",{className:"font-medium",children:e.name}),l.jsx("p",{className:"text-sm text-muted-foreground",children:e.role})]})]}),l.jsxs("div",{className:"text-right space-y-1 text-sm",children:[e.email&&l.jsxs("p",{className:"flex items-center text-muted-foreground",children:[l.jsx(q,{className:"h-3 w-3 mr-1"}),e.email]}),e.phone_number&&l.jsxs("p",{className:"flex items-center text-muted-foreground",children:[l.jsx(X,{className:"h-3 w-3 mr-1"}),e.phone_number]})]})]},e.id)):l.jsx("p",{className:"text-center text-muted-foreground py-8",children:e("guardianView.sections.importantContacts.empty")})})})]}),l.jsxs(w,{variant:"heritage",children:[l.jsxs(v,{children:[l.jsxs(L,{className:"flex items-center",children:[l.jsx($,{className:"h-5 w-5 mr-2"}),e("guardianView.sections.finalWishes.title")]}),l.jsx(R,{children:e("guardianView.sections.finalWishes.description")})]}),l.jsx(b,{children:l.jsxs("div",{className:"space-y-6",children:[(null==h?void 0:h.funeral_wishes)&&l.jsxs("div",{className:"space-y-2",children:[l.jsx("h4",{className:"font-medium text-primary",children:e("guardianView.sections.finalWishes.funeralWishes")}),l.jsx("div",{className:"p-3 bg-muted/30 rounded-lg",children:l.jsx("p",{className:"text-sm",children:h.funeral_wishes})})]}),(null==h?void 0:h.digital_accounts_shutdown)&&l.jsxs("div",{className:"space-y-2",children:[l.jsx("h4",{className:"font-medium text-primary",children:e("guardianView.sections.finalWishes.digitalAccounts")}),l.jsx("div",{className:"p-3 bg-muted/30 rounded-lg",children:l.jsx("p",{className:"text-sm",children:h.digital_accounts_shutdown})})]}),(null==h?void 0:h.messages_to_loved_ones)&&l.jsxs("div",{className:"space-y-2",children:[l.jsx("h4",{className:"font-medium text-primary",children:e("guardianView.sections.finalWishes.messagesToLovedOnes")}),l.jsx("div",{className:"p-3 bg-muted/30 rounded-lg",children:l.jsx("p",{className:"text-sm",children:h.messages_to_loved_ones})})]}),!h&&l.jsx("p",{className:"text-center text-muted-foreground py-8",children:e("guardianView.sections.finalWishes.empty")})]})})]}),l.jsx(w,{children:l.jsxs(b,{className:"text-center py-6",children:[l.jsx(V,{className:"h-8 w-8 text-primary mx-auto mb-2"}),l.jsx("p",{className:"text-sm text-muted-foreground",children:e("guardianView.guardianInfo.description")}),l.jsx("p",{className:"text-xs text-muted-foreground mt-2",children:e("guardianView.guardianInfo.securityNote")})]})}),pe&&xe.length>0&&l.jsxs(w,{className:"border-destructive/50 bg-destructive/5",children:[l.jsxs(v,{children:[l.jsxs(L,{className:"flex items-center justify-between",children:[l.jsxs("span",{className:"flex items-center gap-2 text-destructive",children:[l.jsx(C,{className:"h-5 w-5"}),e("guardianView.emergencyAccess.contactsTitle")]}),l.jsx(_,{variant:"destructive",children:e("guardianView.emergencyAccess.priorityOrder")})]}),l.jsx(R,{children:e("guardianView.emergencyAccess.contactsDescription")})]}),l.jsxs(b,{children:[l.jsx("div",{className:"space-y-4",children:xe.map((s,a)=>l.jsx("div",{className:"p-4 border rounded-lg bg-background",children:l.jsxs("div",{className:"flex items-start justify-between",children:[l.jsxs("div",{className:"flex items-start gap-3",children:[l.jsx("div",{className:"flex items-center justify-center w-8 h-8 rounded-full bg-destructive/10 flex-shrink-0",children:l.jsx("span",{className:"text-sm font-bold text-destructive",children:a+1})}),l.jsxs("div",{className:"space-y-2",children:[l.jsxs("div",{children:[l.jsx("h4",{className:"font-semibold text-lg",children:s.contact.name}),s.contact.relationship&&l.jsx("p",{className:"text-sm text-muted-foreground",children:s.contact.relationship})]}),l.jsxs("div",{className:"space-y-2",children:[s.contact.phone_number&&l.jsxs("div",{className:"flex items-center gap-2",children:[l.jsxs("a",{href:`tel:${s.contact.phone_number}`,className:"flex items-center gap-2 text-sm text-primary hover:underline",children:[l.jsx(K,{className:"h-4 w-4"}),s.contact.phone_number]}),l.jsx(p,{size:"sm",variant:"outline",onClick:()=>ve(s.contact_id),children:e("guardianView.emergencyAccess.logContact")})]}),s.contact.email&&l.jsx("div",{className:"flex items-center gap-2",children:l.jsxs("a",{href:`mailto:${s.contact.email}`,className:"flex items-center gap-2 text-sm text-primary hover:underline",children:[l.jsx(q,{className:"h-4 w-4"}),s.contact.email]})})]})]})]}),l.jsxs("div",{className:"text-right space-y-1",children:[l.jsx(_,{variant:"outline",className:"text-xs",children:e("guardianView.emergencyAccess.priority",{order:a+1})}),s.last_contacted&&l.jsxs("p",{className:"text-xs text-muted-foreground flex items-center gap-1",children:[l.jsx(Q,{className:"h-3 w-3"}),e("guardianView.emergencyAccess.lastContacted",{time:new Date(s.last_contacted).toLocaleString()})]})]})]})},s.id))}),l.jsx("div",{className:"mt-6 p-4 bg-muted/50 rounded-lg",children:l.jsxs("p",{className:"text-sm text-muted-foreground flex items-start gap-2",children:[l.jsx(C,{className:"h-4 w-4 text-destructive flex-shrink-0 mt-0.5"}),e("guardianView.emergencyAccess.importantNote")]})})]})]})]})};export{se as GuardianView};

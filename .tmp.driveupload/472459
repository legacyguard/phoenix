var e=Object.defineProperty,t=(t,s,a)=>((t,s,a)=>s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[s]=a)(t,"symbol"!=typeof s?s+"":s,a),s=(e,t,s)=>new Promise((a,i)=>{var r=e=>{try{o(s.next(e))}catch(t){i(t)}},n=e=>{try{o(s.throw(e))}catch(t){i(t)}},o=e=>e.done?a(e.value):Promise.resolve(e.value).then(r,n);o((s=s.apply(e,t)).next())});import{c as a}from"./index-Co25CVR3.js";import{s as i,O as r}from"./vendor-ai-kPYoZGSZ.js";
/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const n=a("Cloud",[["path",{d:"M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9Z",key:"p7xjir"}]]);class o{constructor(){t(this,"canvas"),t(this,"ctx"),this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d")}preprocessImage(e){return s(this,arguments,function*(e,t={}){const{resize:s=!0,maxWidth:a=2400,maxHeight:i=3200,enhanceContrast:r=!0,removeNoise:n=!0,deskew:o=!1,binarize:c=!0}=t,l=yield this.loadImage(e),{width:g,height:u}=this.calculateDimensions(l.width,l.height,a,i,s);this.canvas.width=g,this.canvas.height=u,this.ctx.drawImage(l,0,0,g,u);let h=this.ctx.getImageData(0,0,g,u);n&&(h=this.removeNoise(h)),r&&(h=this.enhanceContrast(h)),c&&(h=this.binarize(h)),this.ctx.putImageData(h,0,0);const d=yield this.canvasToBlob(this.canvas);return new File([d],e.name,{type:"image/png"})})}loadImage(e){return s(this,null,function*(){return new Promise((t,s)=>{const a=new Image,i=URL.createObjectURL(e);a.onload=()=>{URL.revokeObjectURL(i),t(a)},a.onerror=()=>{URL.revokeObjectURL(i),s(new Error("Failed to load image"))},a.src=i})})}calculateDimensions(e,t,s,a,i){if(!i)return{width:e,height:t};let r=e,n=t;const o=e/t;return r>s&&(r=s,n=r/o),n>a&&(n=a,r=n*o),{width:Math.round(r),height:Math.round(n)}}removeNoise(e){const t=e.data,s=e.width,a=e.height,i=new Uint8ClampedArray(t);for(let r=1;r<a-1;r++)for(let e=1;e<s-1;e++){const a=4*(r*s+e),n=[];for(let i=-1;i<=1;i++)for(let a=-1;a<=1;a++){const o=4*((r+i)*s+(e+a));n.push(t[o])}n.sort((e,t)=>e-t);const o=n[4];i[a]=o,i[a+1]=o,i[a+2]=o}return new ImageData(i,s,a)}enhanceContrast(e){const t=e.data,s=new Array(256).fill(0);for(let c=0;c<t.length;c+=4){s[Math.round(.299*t[c]+.587*t[c+1]+.114*t[c+2])]++}const a=.01*(t.length/4);let i=0,r=255,n=0;for(let c=0;c<256;c++)if(n+=s[c],n>a){i=c;break}n=0;for(let c=255;c>=0;c--)if(n+=s[c],n>a){r=c;break}const o=255/(r-i);for(let c=0;c<t.length;c+=4){const e=Math.round(.299*t[c]+.587*t[c+1]+.114*t[c+2]),s=Math.round((e-i)*o),a=Math.max(0,Math.min(255,s));t[c]=a,t[c+1]=a,t[c+2]=a}return e}binarize(e){const t=e.data,s=new Array(256).fill(0);for(let g=0;g<t.length;g+=4){s[t[g]]++}const a=t.length/4;let i=0;for(let g=0;g<256;g++)i+=g*s[g];let r=0,n=0,o=0,c=0,l=0;for(let g=0;g<256;g++){if(n+=s[g],0===n)continue;if(o=a-n,0===o)break;r+=g*s[g];const e=r/n,t=(i-r)/o,u=n*o*(e-t)*(e-t);u>c&&(c=u,l=g)}for(let g=0;g<t.length;g+=4){const e=t[g]>l?255:0;t[g]=e,t[g+1]=e,t[g+2]=e}return e}canvasToBlob(e){return new Promise((t,s)=>{e.toBlob(e=>{e?t(e):s(new Error("Failed to convert canvas to blob"))},"image/png",1)})}detectOrientation(e){return s(this,null,function*(){return 0})}static anonymizeText(e,t={}){let s=e,a=0;const i=[/\b[A-Z][a-z]+\s+[A-Z][a-z]+\b/g];if([/\d{6}\/\d{3,4}/g,/[A-Z]{2}\d{6}/g,/\+?\d{3}\s?\d{3}\s?\d{3}\s?\d{3}/g,/[\w.-]+@[\w.-]+\.\w+/g,/\d{3}\s?\d{2}\s?\d{2}\s?\d{2}/g].forEach(e=>{const t=s.match(e);t&&(a+=t.length,s=s.replace(e,"[REMOVED]"))}),t.preserveStructure||i.forEach(e=>{const t=s.match(e);t&&(a+=t.length,s=s.replace(e,"[NAME]"))}),!t.preserveDates){const e=/\d{1,2}[./-]\d{1,2}[./-]\d{2,4}/g,t=s.match(e);t&&(a+=t.length,s=s.replace(e,"[DATE]"))}if(!t.preserveAmounts){const e=/\d+[,.\s]?\d*\s*(K|CZK|EUR|USD|\$)/g,t=s.match(e);t&&(a+=t.length,s=s.replace(e,"[AMOUNT]"))}return{text:s,removedCount:a}}}const c={insurance_policy:{type:"insurance_policy",patterns:[{regex:/pojistn\s+smlouva/i,weight:10,language:"cs"},{regex:/pojistnk/i,weight:8,language:"cs"},{regex:/pojitn/i,weight:8,language:"cs"},{regex:/pojistn\s+plnn/i,weight:7,language:"cs"},{regex:/pojistn\s+stka/i,weight:7,language:"cs"},{regex:/potek\s+pojitn/i,weight:6,language:"cs"},{regex:/konec\s+pojitn/i,weight:6,language:"cs"},{regex:/poistn\s+zmluva/i,weight:10,language:"sk"},{regex:/poistnk/i,weight:8,language:"sk"},{regex:/poisten/i,weight:8,language:"sk"},{regex:/poistn\s+plnenie/i,weight:7,language:"sk"},{regex:/\d{10,15}/,weight:3},{regex:/premium|prmie/i,weight:5}],requiredMatches:3,confidenceThreshold:.7},bank_statement:{type:"bank_statement",patterns:[{regex:/vpis\s+z\s+tu/i,weight:10,language:"cs"},{regex:/bankovn\s+vpis/i,weight:10,language:"cs"},{regex:/slo\s+tu/i,weight:8,language:"cs"},{regex:/zstatek/i,weight:7,language:"cs"},{regex:/pjmy/i,weight:6,language:"cs"},{regex:/vdaje/i,weight:6,language:"cs"},{regex:/vpis\s+z\s+tu/i,weight:10,language:"sk"},{regex:/bankov\s+vpis/i,weight:10,language:"sk"},{regex:/slo\s+tu/i,weight:8,language:"sk"},{regex:/zostatok/i,weight:7,language:"sk"},{regex:/[A-Z]{2}\d{2}\s?\d{4}\s?\d{4}\s?\d{4}\s?\d{4}\s?\d{4}/i,weight:8},{regex:/\d{1,2}\.\d{1,2}\.\d{4}.*[+-]?\d+[,.]\d{2}/,weight:5}],requiredMatches:3,confidenceThreshold:.75},property_deed:{type:"property_deed",patterns:[{regex:/list\s+vlastnictv/i,weight:10,language:"cs"},{regex:/vpis\s+z\s+katastru\s+nemovitost/i,weight:10,language:"cs"},{regex:/katastrln\s+zem/i,weight:8,language:"cs"},{regex:/parcela/i,weight:7,language:"cs"},{regex:/vlastnick\s+prvo/i,weight:8,language:"cs"},{regex:/spoluvlastnick\s+podl/i,weight:7,language:"cs"},{regex:/list\s+vlastnctva/i,weight:10,language:"sk"},{regex:/vpis\s+z\s+katastra\s+nehnutenost/i,weight:10,language:"sk"},{regex:/katastrlne\s+zemie/i,weight:8,language:"sk"},{regex:/LV\s*\.\s*\d+/i,weight:9},{regex:/\d+\/\d+/,weight:5}],requiredMatches:3,confidenceThreshold:.8},identity_card:{type:"identity_card",patterns:[{regex:/obansk\s+prkaz/i,weight:10,language:"cs"},{regex:/esk\s+republika/i,weight:8,language:"cs"},{regex:/jmno\s+a\s+pjmen/i,weight:7,language:"cs"},{regex:/datum\s+narozen/i,weight:7,language:"cs"},{regex:/rodn\s+slo/i,weight:8,language:"cs"},{regex:/platnost\s+do/i,weight:6,language:"cs"},{regex:/obiansky\s+preukaz/i,weight:10,language:"sk"},{regex:/slovensk\s+republika/i,weight:8,language:"sk"},{regex:/meno\s+a\s+priezvisko/i,weight:7,language:"sk"},{regex:/dtum\s+narodenia/i,weight:7,language:"sk"},{regex:/rodn\s+slo/i,weight:8,language:"sk"},{regex:/\d{6}\/\d{3,4}/,weight:9},{regex:/[A-Z]{2}\d{6}/,weight:8}],requiredMatches:4,confidenceThreshold:.85},passport:{type:"passport",patterns:[{regex:/cestovn\s+pas/i,weight:10,language:"cs"},{regex:/pas\s+esk\s+republiky/i,weight:10,language:"cs"},{regex:/cestovn\s+pas/i,weight:10,language:"sk"},{regex:/pas\s+slovenskej\s+republiky/i,weight:10,language:"sk"},{regex:/passport/i,weight:9},{regex:/[A-Z]{1,2}\d{6,8}/,weight:8},{regex:/MRZ/,weight:7},{regex:/P<[A-Z]{3}/,weight:9}],requiredMatches:2,confidenceThreshold:.8},will:{type:"will",patterns:[{regex:/zv/i,weight:10,language:"cs"},{regex:/posledn\s+vle/i,weight:10,language:"cs"},{regex:/zstavitel/i,weight:8,language:"cs"},{regex:/ddic/i,weight:7,language:"cs"},{regex:/odkazuji/i,weight:7,language:"cs"},{regex:/zvet/i,weight:10,language:"sk"},{regex:/posledn\s+va/i,weight:10,language:"sk"},{regex:/poruite/i,weight:8,language:"sk"},{regex:/dedi/i,weight:7,language:"sk"},{regex:/not|notr/i,weight:6},{regex:/svdek|svedok/i,weight:5}],requiredMatches:3,confidenceThreshold:.75},medical_record:{type:"medical_record",patterns:[{regex:/zdravotn\s+dokumentace/i,weight:10,language:"cs"},{regex:/lkask\s+zprva/i,weight:10,language:"cs"},{regex:/diagnza/i,weight:8,language:"cs"},{regex:/anamnza/i,weight:7,language:"cs"},{regex:/vyeten/i,weight:6,language:"cs"},{regex:/zdravotn\s+dokumentcia/i,weight:10,language:"sk"},{regex:/lekrska\s+sprva/i,weight:10,language:"sk"},{regex:/diagnza/i,weight:8,language:"sk"},{regex:/ICD-?\d{1,2}/,weight:7},{regex:/MKN-?\d{1,2}/,weight:7}],requiredMatches:3,confidenceThreshold:.7},contract:{type:"contract",patterns:[{regex:/smlouva/i,weight:10,language:"cs"},{regex:/smluvn\s+strany/i,weight:8,language:"cs"},{regex:/pedmt\s+smlouvy/i,weight:7,language:"cs"},{regex:/lnek\s+[IVX\d]+/i,weight:5,language:"cs"},{regex:/zmluva/i,weight:10,language:"sk"},{regex:/zmluvn\s+strany/i,weight:8,language:"sk"},{regex:/predmet\s+zmluvy/i,weight:7,language:"sk"},{regex:/IO?\s*:?\s*\d{8}/,weight:6},{regex:/DI\s*:?\s*\d{10}/,weight:6}],requiredMatches:3,confidenceThreshold:.65},invoice:{type:"invoice",patterns:[{regex:/faktura/i,weight:10,language:"cs"},{regex:/daov\s+doklad/i,weight:10,language:"cs"},{regex:/variabiln\s+symbol/i,weight:8,language:"cs"},{regex:/datum\s+splatnosti/i,weight:7,language:"cs"},{regex:/celkem\s+k\s+hrad/i,weight:8,language:"cs"},{regex:/faktra/i,weight:10,language:"sk"},{regex:/daov\s+doklad/i,weight:10,language:"sk"},{regex:/variabiln\s+symbol/i,weight:8,language:"sk"},{regex:/DPH\s*\d{1,2}\s*%/,weight:7},{regex:/I\s*DPH/,weight:6},{regex:/\d+[,.]\d{2}\s*(K|CZK||EUR)/,weight:6}],requiredMatches:3,confidenceThreshold:.75},receipt:{type:"receipt",patterns:[{regex:/tenka/i,weight:10,language:"cs"},{regex:/paragon/i,weight:10,language:"cs"},{regex:/prodejn\s+doklad/i,weight:9,language:"cs"},{regex:/tenka/i,weight:10,language:"sk"},{regex:/pokladnin\s+doklad/i,weight:9,language:"sk"},{regex:/EET/,weight:8},{regex:/FIK\s*:/,weight:9},{regex:/BKP\s*:/,weight:8},{regex:/celkem\s*:?\s*\d+[,.]\d{2}/,weight:7}],requiredMatches:2,confidenceThreshold:.7},unknown:{type:"unknown",patterns:[],requiredMatches:0,confidenceThreshold:0}};function l(e){let t=0,s=0,a=0;return[/esk|esk|esk/i,/praha/i,/oban/i,/prkaz/i,/msto/i].forEach(s=>{s.test(e)&&t++}),[/slovensk|slovensk|slovensk/i,/bratislava/i,/oban/i,/preukaz/i,/mesto/i].forEach(t=>{t.test(e)&&s++}),[/the|and|of|to|in/i,/document|certificate|statement/i].forEach(t=>{t.test(e)&&a++}),t>s&&t>a?"cs":s>t&&s>a?"sk":a>0?"en":"other"}const g=new class{constructor(){t(this,"worker",null),t(this,"preprocessor"),t(this,"isInitialized",!1),t(this,"initializationPromise",null),this.preprocessor=new o}initialize(e="eng"){return s(this,null,function*(){if(!this.isInitialized||!this.worker)return this.initializationPromise||(this.initializationPromise=this.doInitialize(e)),this.initializationPromise})}doInitialize(e){return s(this,null,function*(){try{this.worker=yield i.createWorker({logger:e=>{},langPath:"https://tessdata.projectnaptha.com/4.0.0",cachePath:"./tesseract-cache",cacheMethod:"write"});const t={cs:"ces",sk:"slk",en:"eng"}[e]||e;yield this.worker.loadLanguage(t),yield this.worker.initialize(t),yield this.worker.setParameters({tessedit_char_whitelist:'0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz .,;:!?()[]{}/-_@#$%&*+="\'"',preserve_interword_spaces:"1"}),this.isInitialized=!0}catch(t){throw this.initializationPromise=null,this.createError("initialization_failed",t)}})}extractTextFromImage(e){return s(this,arguments,function*(e,t={}){var s,a,i,r,n;const o=Date.now();try{if(null==(s=t.onProgress)||s.call(t,{status:"initializing",progress:0,message:"Preparing to read your document..."}),!e.type.startsWith("image/"))throw this.createError("unsupported_format","Please upload an image file");if(e.size>52428800)throw this.createError("file_too_large","File is too large. Please upload a smaller image");let c=e;t.preprocessImage&&(null==(a=t.onProgress)||a.call(t,{status:"preprocessing",progress:10,message:"Enhancing document quality..."}),c=yield this.preprocessor.preprocessImage(e));const l=yield this.detectDocumentLanguage(c),g=t.language||l;yield this.initialize(g),null==(i=t.onProgress)||i.call(t,{status:"recognizing",progress:20,message:"Reading your document..."});const u=yield this.fileToImageData(c),h=yield this.worker.recognize(u),d=h.data.text,m=h.data.confidence;null==(r=t.onProgress)||r.call(t,{status:"postprocessing",progress:80,message:"Analyzing document content..."});const p=this.detectDocumentType(d);let w;"unknown"!==p.type&&(w=yield this.extractStructuredData(d,p.type)),null==(n=t.onProgress)||n.call(t,{status:"complete",progress:100,message:"Document processed successfully!"});return{text:d,confidence:m,language:g,processingTime:Date.now()-o,documentType:p,structuredData:w,isLocalOnly:t.localOnly||!0,timestamp:new Date}}catch(c){throw this.createError("processing_failed",c)}})}detectDocumentLanguage(e){return s(this,null,function*(){try{const t=yield i.createWorker();yield t.loadLanguage("eng+ces+slk"),yield t.initialize("eng+ces+slk");const s=yield this.fileToImageData(e),a=yield t.recognize(s);yield t.terminate();return l(a.data.text.substring(0,500))}catch(t){return"en"}})}detectDocumentType(e){let t={type:"unknown",confidence:0,matchedPatterns:[],language:l(e)};for(const[s,a]of Object.entries(c)){if("unknown"===s)continue;const i=[];let r=0,n=0;for(const t of a.patterns)t.regex.test(e)&&(i.push(t.regex.source),r+=t.weight,n++);if(n>=a.requiredMatches){const n=r/a.patterns.reduce((e,t)=>e+t.weight,0);n>t.confidence&&n>=a.confidenceThreshold&&(t={type:s,confidence:n,matchedPatterns:i,language:l(e)})}}return t}extractStructuredData(e,t){return s(this,null,function*(){const s={},a=/\d{1,2}[./-]\d{1,2}[./-]\d{2,4}/g,i=/\d+[,.\s]?\d*\s*(K|CZK|EUR|USD|\$)/g,r=/\d{6}\/\d{3,4}/g,n=e.match(a);n&&n.length>0&&(s.issueDate=this.parseDate(n[0]),n.length>1&&(s.expiryDate=this.parseDate(n[1])));const o=e.match(i);switch(o&&(s.amounts=o.map(e=>{const t=e.match(/(\d+[,.\s]?\d*)\s*(K|CZK||EUR|USD|\$)/);return t?{value:parseFloat(t[1].replace(/[,\s]/g,"").replace(",",".")),currency:t[2]}:{value:0,currency:"CZK"}})),t){case"insurance_policy":s.policyNumber=this.extractPattern(e,/\d{10,15}/),s.insuredPerson=this.extractPattern(e,/pojitn:?\s*([^\n]+)/i);break;case"bank_statement":s.customFields={accountNumber:this.extractPattern(e,/\d{4,6}\/\d{4}/),iban:this.extractPattern(e,/[A-Z]{2}\d{2}\s?\d{4}\s?\d{4}\s?\d{4}\s?\d{4}\s?\d{4}/)};break;case"property_deed":s.cadastralNumber=this.extractPattern(e,/\d+\/\d+/),s.propertyAddress=this.extractPattern(e,/(?:adresa|address):?\s*([^\n]+)/i);break;case"identity_card":s.documentNumber=this.extractPattern(e,/[A-Z]{2}\d{6}/),s.identificationNumbers=e.match(r)||[]}return s})}extractTextWithRegions(e){return s(this,null,function*(){yield this.initialize();const t=yield this.fileToImageData(e);return(yield this.worker.recognize(t)).data.words.map(e=>({text:e.text,confidence:e.confidence,bbox:e.bbox,pageNumber:1,isHandwritten:e.confidence<70}))})}anonymizeText(e,t={}){const{text:s,removedCount:a}=o.anonymizeText(e,t);return{text:s,removedEntities:[{type:"name",count:a}],documentStructure:{type:this.detectDocumentType(e).type,hasFinancialData:/\d+[,.\s]?\d*\s*(K|CZK||EUR|USD|\$)/.test(e),hasDates:/\d{1,2}[./-]\d{1,2}[./-]\d{2,4}/.test(e),hasSignatures:/podpis|signature/i.test(e)}}}fileToImageData(e){return s(this,null,function*(){return new Promise((t,s)=>{const a=new FileReader;a.onload=()=>t(a.result),a.onerror=s,a.readAsDataURL(e)})})}parseDate(e){const t=e.split(/[./-]/);if(3===t.length){const e=parseInt(t[0]),s=parseInt(t[1])-1,a=2===t[2].length?2e3+parseInt(t[2]):parseInt(t[2]);return new Date(a,s,e)}return new Date(e)}extractPattern(e,t){const s=e.match(t);return s?s[1]||s[0]:""}createError(e,t){return{code:e,message:t instanceof Error?t.message:String(t),userMessage:{initialization_failed:"Having trouble starting the document reader. Please try again.",processing_failed:"Could not read your document. Please ensure the image is clear.",unsupported_format:"This file type is not supported. Please upload an image.",file_too_large:"This file is too large. Please upload a smaller image.",worker_error:"Something went wrong. Please refresh and try again."}[e],details:t}}terminate(){return s(this,null,function*(){this.worker&&(yield this.worker.terminate(),this.worker=null,this.isInitialized=!1,this.initializationPromise=null)})}},u={apiKey:"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",organizationId:"org-imTetkLKlcKDeviIv8KCJNFn",models:{simple:"gpt-3.5-turbo",complex:"gpt-4-turbo-preview",vision:"gpt-4-vision-preview"},rateLimits:{requestsPerMinute:20,requestsPerHour:100,requestsPerDay:1e3,tokensPerMinute:4e4,tokensPerHour:2e5,tokensPerDay:1e6},retry:{maxAttempts:3,initialDelay:1e3,maxDelay:1e4,backoffMultiplier:2},timeouts:{simple:1e4,complex:3e4,vision:6e4},tokenLimits:{maxPromptTokens:3e3,maxCompletionTokens:1e3,maxTotalTokens:4e3},pricing:{"gpt-3.5-turbo":{prompt:5e-4,completion:.0015},"gpt-4-turbo-preview":{prompt:.01,completion:.03},"gpt-4-vision-preview":{prompt:.01,completion:.03}},cache:{enabled:!0,ttl:36e5,maxSize:100},userLimits:{daily:{free:50,basic:500,premium:5e3},monthly:{free:1e3,basic:1e4,premium:1e5}},systemPrompts:{documentAnalysis:"You are an empathetic AI assistant helping people organize their important life documents. \n    Analyze documents with care and understanding, focusing on what matters most to families. \n    Be thorough but gentle, and always consider the emotional weight of estate planning.",lifeQuestions:"You are a caring companion helping people capture their life stories and wishes. \n    Ask thoughtful, open-ended questions that encourage reflection without being intrusive. \n    Focus on preserving memories, values, and guidance for loved ones.",suggestions:"You are a supportive guide helping people complete their digital legacy planning. \n    Provide gentle, encouraging suggestions that make the process feel manageable and meaningful. \n    Always acknowledge the emotional difficulty of this task.",empathetic:"You are a compassionate assistant providing emotional support during estate planning. \n    Use warm, understanding language that validates feelings while encouraging progress. \n    Never be pushy or clinical - this is about people, not paperwork."}};class h extends Error{constructor(e){super(e.message),t(this,"code"),t(this,"userMessage"),t(this,"retryable"),t(this,"retryAfter"),this.name="OpenAIServiceError",this.code=e.code,this.userMessage=e.userMessage,this.retryable=e.retryable,this.retryAfter=e.retryAfter}}class d{constructor(){t(this,"requests",[]),t(this,"tokens",[])}canMakeRequest(){const e=Date.now(),t=e-6e4,s=e-36e5;this.requests=this.requests.filter(e=>e>s);const a=this.requests.filter(e=>e>t).length,i=this.requests.length;return a<u.rateLimits.requestsPerMinute&&i<u.rateLimits.requestsPerHour}recordRequest(e){const t=Date.now();this.requests.push(t),this.tokens.push(e)}getRetryAfter(){const e=Date.now(),t=e-6e4;if(this.requests.filter(e=>e>t).length>=u.rateLimits.requestsPerMinute){return 6e4-(e-Math.min(...this.requests.filter(e=>e>t)))}return 1e3}}class m{constructor(){t(this,"cache",new Map)}get(e){const t=this.cache.get(e);if(!t)return null;return Date.now()-t.timestamp>u.cache.ttl?(this.cache.delete(e),null):t.data}set(e,t){if(this.cache.size>=u.cache.maxSize){const e=Array.from(this.cache.entries()).sort(([,e],[,t])=>e.timestamp-t.timestamp)[0][0];this.cache.delete(e)}this.cache.set(e,{data:t,timestamp:Date.now()})}clear(){this.cache.clear()}}const p=new class{constructor(){t(this,"client",null),t(this,"rateLimiter",new d),t(this,"cache",new m),t(this,"requestQueue",[]),t(this,"processing",!1),this.client=new r({apiKey:u.apiKey,organization:u.organizationId,dangerouslyAllowBrowser:!0})}estimateTokens(e){return Math.ceil(e.length/4)}calculateCost(e,t){const s=u.pricing[t];if(!s)return 0;const a=e.prompt/1e3*s.prompt,i=e.completion/1e3*s.completion;return Number((a+i).toFixed(4))}withRetry(e){return s(this,arguments,function*(e,t={}){const s=t.maxRetries||u.retry.maxAttempts;let a=0,i=u.retry.initialDelay;for(;a<s;)try{if(!this.rateLimiter.canMakeRequest()){const e=this.rateLimiter.getRetryAfter();throw new h({code:"rate_limit",message:"Rate limit exceeded",userMessage:"We're processing many requests. Please wait a moment.",retryable:!0,retryAfter:e})}return yield e()}catch(n){if(a++,n instanceof h){if(!n.retryable||a>=s)throw n;n.retryAfter&&(i=n.retryAfter)}else{if(!(n instanceof r.APIError))throw n;{const e=this.handleOpenAIError(n);if(!e.retryable||a>=s)throw new h(e);e.retryAfter&&(i=e.retryAfter)}}yield new Promise(e=>setTimeout(e,i)),i=Math.min(i*u.retry.backoffMultiplier,u.retry.maxDelay)}throw new Error("Max retry attempts reached")})}handleOpenAIError(e){return 429===e.status?{code:"rate_limit",message:e.message,userMessage:"We're experiencing high demand. Please try again in a moment.",retryable:!0,retryAfter:6e4}:401===e.status?{code:"authentication",message:e.message,userMessage:"There's an issue with our service. Please contact support.",retryable:!1}:400===e.status?{code:"invalid_request",message:e.message,userMessage:"There was an issue processing your request. Please try again.",retryable:!1}:e.status&&e.status>=500?{code:"server_error",message:e.message,userMessage:"Our AI service is temporarily unavailable. Please try again later.",retryable:!0,retryAfter:5e3}:{code:"unknown",message:e.message,userMessage:"An unexpected error occurred. Please try again.",retryable:!0}}makeRequest(e,t){return s(this,arguments,function*(e,t,s={}){try{if(u.cache.enabled){const t=this.cache.get(e);if(t)return{success:!0,data:t,cached:!0,timestamp:new Date}}const a=yield this.withRetry(t,s);return this.rateLimiter.recordRequest(a.usage.total),u.cache.enabled&&this.cache.set(e,a.data),{success:!0,data:a.data,usage:a.usage,cached:!1,timestamp:new Date}}catch(a){return a instanceof h?{success:!1,error:{code:a.code,message:a.message,userMessage:a.userMessage,retryable:a.retryable,retryAfter:a.retryAfter},timestamp:new Date}:{success:!1,error:{code:"unknown",message:a instanceof Error?a.message:"Unknown error",userMessage:"An unexpected error occurred. Please try again.",retryable:!1},timestamp:new Date}}})}analyzeDocument(e){return s(this,arguments,function*(e,t={}){if(!this.client)return{success:!1,error:{code:"authentication",message:"OpenAI client not initialized",userMessage:"AI service is not configured properly.",retryable:!1},timestamp:new Date};const a=`analyze_${e.substring(0,50)}`;return this.makeRequest(a,()=>s(this,null,function*(){var t,s,a;const i=yield this.client.chat.completions.create({model:u.models.vision,messages:[{role:"system",content:u.systemPrompts.documentAnalysis},{role:"user",content:[{type:"text",text:"Please analyze this document and extract key information. Identify the document type, extract relevant data, and suggest related documents that might be helpful."},{type:"image_url",image_url:{url:`data:image/jpeg;base64,${e}`}}]}],max_tokens:u.tokenLimits.maxCompletionTokens,temperature:.3,response_format:{type:"json_object"}}),r=JSON.parse(i.choices[0].message.content||"{}"),n={prompt:(null==(t=i.usage)?void 0:t.prompt_tokens)||0,completion:(null==(s=i.usage)?void 0:s.completion_tokens)||0,total:(null==(a=i.usage)?void 0:a.total_tokens)||0,estimatedCost:0};return n.estimatedCost=this.calculateCost(n,u.models.vision),{data:r,usage:n}}),t)})}generateLifeQuestion(e){return s(this,arguments,function*(e,t={}){if(!this.client)return{success:!1,error:{code:"authentication",message:"OpenAI client not initialized",userMessage:"AI service is not configured properly.",retryable:!1},timestamp:new Date};const a=`question_${e.id}_${e.documentsCount}`;return this.makeRequest(a,()=>s(this,null,function*(){var t,s,a,i;const r=yield this.client.chat.completions.create({model:u.models.simple,messages:[{role:"system",content:u.systemPrompts.lifeQuestions},{role:"user",content:`Generate a thoughtful life question for a user with the following profile:\n              Name: ${e.name}\n              Age: ${e.age||"Not specified"}\n              Family Members: ${e.familyMembers||"Not specified"}\n              Documents Uploaded: ${e.documentsCount}\n              Communication Style: ${(null==(t=e.preferences)?void 0:t.communicationStyle)||"empathetic"}\n              \n              Create a question that encourages reflection on life, legacy, or family values.`}],max_tokens:500,temperature:.8,response_format:{type:"json_object"}}),n=JSON.parse(r.choices[0].message.content||"{}"),o={prompt:(null==(s=r.usage)?void 0:s.prompt_tokens)||0,completion:(null==(a=r.usage)?void 0:a.completion_tokens)||0,total:(null==(i=r.usage)?void 0:i.total_tokens)||0,estimatedCost:0};return o.estimatedCost=this.calculateCost(o,u.models.simple),{data:n,usage:o}}),t)})}suggestNextAction(e){return s(this,arguments,function*(e,t={}){if(!this.client)return{success:!1,error:{code:"authentication",message:"OpenAI client not initialized",userMessage:"AI service is not configured properly.",retryable:!1},timestamp:new Date};const a=`action_${e.currentPage}_${e.completionPercentage}`;return this.makeRequest(a,()=>s(this,null,function*(){var t,s,a;const i=yield this.client.chat.completions.create({model:u.models.simple,messages:[{role:"system",content:u.systemPrompts.suggestions},{role:"user",content:`Suggest a helpful next action for a user with this context:\n              Current Page: ${e.currentPage}\n              Recent Actions: ${e.recentActions.join(", ")}\n              Documents Uploaded: ${e.documentsUploaded}\n              Completion: ${e.completionPercentage}%\n              Mood: ${e.mood||"neutral"}\n              \n              Provide an encouraging, actionable suggestion that feels manageable.`}],max_tokens:300,temperature:.7,response_format:{type:"json_object"}}),r=JSON.parse(i.choices[0].message.content||"{}"),n={prompt:(null==(t=i.usage)?void 0:t.prompt_tokens)||0,completion:(null==(s=i.usage)?void 0:s.completion_tokens)||0,total:(null==(a=i.usage)?void 0:a.total_tokens)||0,estimatedCost:0};return n.estimatedCost=this.calculateCost(n,u.models.simple),{data:r,usage:n}}),t)})}extractDocumentMetadata(e,t){return s(this,arguments,function*(e,t,a={}){if(!this.client)return{success:!1,error:{code:"authentication",message:"OpenAI client not initialized",userMessage:"AI service is not configured properly.",retryable:!1},timestamp:new Date};const i=`metadata_${t}_${e.substring(0,50)}`;return this.makeRequest(i,()=>s(this,null,function*(){var s,a,i;const r=yield this.client.chat.completions.create({model:u.models.simple,messages:[{role:"system",content:"Extract structured metadata from the document text. Focus on dates, parties involved, and key information."},{role:"user",content:`Extract metadata from this ${t} document:\n\n${e}`}],max_tokens:500,temperature:.2,response_format:{type:"json_object"}}),n=JSON.parse(r.choices[0].message.content||"{}"),o={prompt:(null==(s=r.usage)?void 0:s.prompt_tokens)||0,completion:(null==(a=r.usage)?void 0:a.completion_tokens)||0,total:(null==(i=r.usage)?void 0:i.total_tokens)||0,estimatedCost:0};return o.estimatedCost=this.calculateCost(o,u.models.simple),{data:n,usage:o}}),a)})}generateEmpatheticMessage(e){return s(this,arguments,function*(e,t="supportive",a={}){if(!this.client)return{success:!1,error:{code:"authentication",message:"OpenAI client not initialized",userMessage:"AI service is not configured properly.",retryable:!1},timestamp:new Date};const i=`message_${e}_${t}`;return this.makeRequest(i,()=>s(this,null,function*(){var s,a,i;const r=yield this.client.chat.completions.create({model:u.models.simple,messages:[{role:"system",content:u.systemPrompts.empathetic},{role:"user",content:`Generate a ${t} message for this scenario: ${e}\n              \n              Keep it brief (2-3 sentences), warm, and encouraging.`}],max_tokens:150,temperature:.8}),n=r.choices[0].message.content||"",o={prompt:(null==(s=r.usage)?void 0:s.prompt_tokens)||0,completion:(null==(a=r.usage)?void 0:a.completion_tokens)||0,total:(null==(i=r.usage)?void 0:i.total_tokens)||0,estimatedCost:0};return o.estimatedCost=this.calculateCost(o,u.models.simple),{data:n,usage:o}}),a)})}clearCache(){this.cache.clear()}getUsageStats(){return{cacheSize:this.cache.cache.size,queueLength:this.requestQueue.length}}};export{n as C,p as a,g as o};

var e=Object.defineProperty,s=Object.defineProperties,t=Object.getOwnPropertyDescriptors,r=Object.getOwnPropertySymbols,i=Object.prototype.hasOwnProperty,n=Object.prototype.propertyIsEnumerable,a=(s,t,r)=>t in s?e(s,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):s[t]=r,c=(e,s,t)=>new Promise((r,i)=>{var n=e=>{try{c(t.next(e))}catch(s){i(s)}},a=e=>{try{c(t.throw(e))}catch(s){i(s)}},c=e=>e.done?r(e.value):Promise.resolve(e.value).then(n,a);c((t=t.apply(e,s)).next())});import{j as l}from"./vendor-ui-DOX-GngI.js";import{r as o}from"./vendor-react-BsuoGMue.js";import{c as d,t as m,h as p,a0 as u,C as x,a as h,b as j,e as f,A as b,i as y,a4 as v,n as g,Q as w,R as _,V as N,Y as P,d as k,B as D,r as S,aa as O,l as R,p as z,L as C,_ as F}from"./index-Co25CVR3.js";import{s as U}from"./supabaseWithRetry-Cm5ZSG7b.js";import{u as E}from"./vendor-i18n-C5HfoztV.js";import{d as T,f as q}from"./vendor-utils-DZ4dNBww.js";import{D as M}from"./dollar-sign-DZs5lViZ.js";import{T as B}from"./trending-up-D8-VI5LC.js";import{P as L}from"./phone-CASw_iL6.js";import"./vendor-auth-CQQWOfx5.js";import"./vendor-supabase-DjxWZ-e5.js";
/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Q=d("RotateCw",[["path",{d:"M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8",key:"1p45f6"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}]]),V=()=>{const{t:e}=E("common"),[d,V]=o.useState(!0),[W,Y]=o.useState([]),[A,G]=o.useState(null),[I,K]=o.useState("overview"),[H,J]=o.useState(0),[X,Z]=o.useState(0),[$,ee]=o.useState([]),se=o.useCallback(()=>c(void 0,null,function*(){try{V(!0);const{data:{user:e}}=yield U.auth.getUser();if(!e)return;const{data:s,error:t}=yield U.from("documents").select("*").in("subscription_type",["monthly","yearly"]).not("renewal_cost","is",null).order("renewal_date",{ascending:!0});if(t)throw t;const{data:r,error:i}=yield U.from("subscription_preferences").select("*").eq("user_id",e.id).single();if(i&&"PGRST116"!==i.code)throw i;if(r)G(r);else{const{data:s}=yield U.from("subscription_preferences").insert({user_id:e.id,tracking_enabled:!0,tracked_document_types:["insurance_policy","energy_contract","software_license","subscription_service"],default_reminder_days:[90,60,30,7],cost_optimization_enabled:!0}).select().single();G(s)}Y(s||[]),te(s||[]),re(s||[])}catch(s){m.error(e("subscription.loadError"))}finally{V(!1)}}),[e]);o.useEffect(()=>{se()},[se]);const te=e=>{let s=0,t=0;e.forEach(e=>{"monthly"===e.subscription_type?(s+=e.renewal_cost,t+=12*e.renewal_cost):"yearly"===e.subscription_type&&(t+=e.renewal_cost,s+=e.renewal_cost/12)}),J(s),Z(t)},re=e=>{const s=e.filter(e=>{if(!e.renewal_date)return!1;const s=T(new Date(e.renewal_date),new Date);return s>=0&&s<=90});ee(s)},ie=(l,o)=>c(void 0,null,function*(){var c;if(A)try{const{data:{user:d}}=yield U.auth.getUser();if(!d)return;const p=(c=((e,s)=>{for(var t in s||(s={}))i.call(s,t)&&a(e,t,s[t]);if(r)for(var t of r(s))n.call(s,t)&&a(e,t,s[t]);return e})({},A),s(c,t({[l]:o}))),{error:u}=yield U.from("subscription_preferences").update(p).eq("user_id",d.id);if(u)throw u;G(p),m.success(e("subscription.preferencesUpdated"))}catch(d){m.error(e("subscription.updateError"))}}),ne=e=>T(new Date(e),new Date),ae=e=>e<=7?"destructive":e<=30?"secondary":"outline";return d?l.jsx("div",{className:"flex items-center justify-center h-64",children:l.jsxs("div",{className:"text-center space-y-2",children:[l.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto"}),l.jsx("p",{className:"text-sm text-muted-foreground",children:e("common.loading")})]})}):l.jsxs("div",{className:"space-y-6",children:[l.jsxs("div",{className:"flex items-center justify-between",children:[l.jsxs("div",{children:[l.jsx("h2",{className:"text-2xl font-bold",children:e("subscription.dashboard.title")}),l.jsx("p",{className:"text-muted-foreground",children:e("subscription.dashboard.subtitle")})]}),l.jsxs(p,{variant:"outline",size:"sm",children:[l.jsx(u,{className:"h-4 w-4 mr-2"}),e("subscription.exportReport")]})]}),l.jsxs("div",{className:"grid gap-4 md:grid-cols-3",children:[l.jsxs(x,{children:[l.jsxs(h,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[l.jsx(j,{className:"text-sm font-medium",children:e("subscription.monthlyCost")}),l.jsx(M,{className:"h-4 w-4 text-muted-foreground"})]}),l.jsxs(f,{children:[l.jsxs("div",{className:"text-2xl font-bold",children:["€",H.toFixed(2)]}),l.jsx("p",{className:"text-xs text-muted-foreground",children:e("subscription.perMonth")})]})]}),l.jsxs(x,{children:[l.jsxs(h,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[l.jsx(j,{className:"text-sm font-medium",children:e("subscription.yearlyCost")}),l.jsx(B,{className:"h-4 w-4 text-muted-foreground"})]}),l.jsxs(f,{children:[l.jsxs("div",{className:"text-2xl font-bold",children:["€",X.toFixed(2)]}),l.jsx("p",{className:"text-xs text-muted-foreground",children:e("subscription.perYear")})]})]}),l.jsxs(x,{children:[l.jsxs(h,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[l.jsx(j,{className:"text-sm font-medium",children:e("subscription.activeSubscriptions")}),l.jsx(Q,{className:"h-4 w-4 text-muted-foreground"})]}),l.jsxs(f,{children:[l.jsx("div",{className:"text-2xl font-bold",children:W.length}),l.jsxs("p",{className:"text-xs text-muted-foreground",children:[$.length," ",e("subscription.upcomingSoon")]})]})]})]}),$.length>0&&l.jsxs(b,{className:"border-primary",children:[l.jsx(y,{className:"h-4 w-4"}),l.jsx(v,{children:e("subscription.upcomingRenewalsTitle")}),l.jsx(g,{children:e("subscription.upcomingRenewalsDesc",{count:$.length})})]}),l.jsxs(w,{value:I,onValueChange:K,children:[l.jsxs(_,{className:"grid w-full grid-cols-3",children:[l.jsx(N,{value:"overview",children:e("subscription.tabs.overview")}),l.jsx(N,{value:"upcoming",children:e("subscription.tabs.upcoming")}),l.jsx(N,{value:"settings",children:e("subscription.tabs.settings")})]}),l.jsx(P,{value:"overview",className:"space-y-4",children:l.jsxs(x,{children:[l.jsxs(h,{children:[l.jsx(j,{children:e("subscription.allSubscriptions")}),l.jsx(k,{children:e("subscription.allSubscriptionsDesc")})]}),l.jsx(f,{children:l.jsx("div",{className:"space-y-4",children:W.map(s=>{const t=ne(s.renewal_date);return l.jsxs("div",{className:"flex items-center justify-between p-4 border rounded-lg",children:[l.jsxs("div",{className:"space-y-1",children:[l.jsxs("div",{className:"flex items-center gap-2",children:[l.jsx("h4",{className:"font-medium",children:s.name}),l.jsx(D,{variant:s.auto_renewal?"default":"secondary",children:s.auto_renewal?e("subscription.autoRenewal"):e("subscription.manual")})]}),l.jsxs("p",{className:"text-sm text-muted-foreground",children:["monthly"===s.subscription_type?e("subscription.types.monthly"):e("subscription.types.yearly"),e("subscriptions.subscriptionDashboard._1"),"€",s.renewal_cost.toFixed(2),"monthly"===s.subscription_type?"/mo":"/yr"]}),s.provider_contact_info&&l.jsxs("div",{className:"flex items-center gap-4 text-xs text-muted-foreground",children:[s.provider_contact_info.phone&&l.jsxs("span",{className:"flex items-center gap-1",children:[l.jsx(L,{className:"h-3 w-3"}),s.provider_contact_info.phone]}),s.provider_contact_info.email&&l.jsxs("span",{className:"flex items-center gap-1",children:[l.jsx(S,{className:"h-3 w-3"}),s.provider_contact_info.email]}),s.provider_contact_info.website&&l.jsxs("span",{className:"flex items-center gap-1",children:[l.jsx(O,{className:"h-3 w-3"}),s.provider_contact_info.website]})]})]}),l.jsxs("div",{className:"flex items-center gap-4",children:[l.jsxs("div",{className:"text-right",children:[l.jsx("p",{className:"text-sm font-medium",children:q(new Date(s.renewal_date),"PPP")}),l.jsxs(D,{variant:ae(t),children:[t," ",e("subscription.daysUntilRenewal")]})]}),l.jsx(R,{className:"h-4 w-4 text-muted-foreground"})]})]},s.id)})})})]})}),l.jsx(P,{value:"upcoming",className:"space-y-4",children:l.jsxs(x,{children:[l.jsxs(h,{children:[l.jsx(j,{children:e("subscription.upcomingRenewals")}),l.jsx(k,{children:e("subscription.next90Days")})]}),l.jsx(f,{children:l.jsxs("div",{className:"space-y-4",children:[$.map(s=>{const t=ne(s.renewal_date);return l.jsx(b,{className:z("border-l-4",t<=7?"border-l-destructive":t<=30?"border-l-yellow-500":"border-l-muted-foreground"),children:l.jsxs("div",{className:"flex items-start justify-between",children:[l.jsxs("div",{className:"space-y-1",children:[l.jsxs("h4",{className:"font-medium flex items-center gap-2",children:[s.name,l.jsxs(D,{variant:ae(t),children:[t," ",e("subscription.days")]})]}),l.jsxs("p",{className:"text-sm text-muted-foreground",children:["€",s.renewal_cost.toFixed(2)," • ",q(new Date(s.renewal_date),"PPP")]}),s.cancellation_notice_period>0&&t<=s.cancellation_notice_period&&l.jsxs("p",{className:"text-sm text-destructive flex items-center gap-1",children:[l.jsx(y,{className:"h-3 w-3"}),e("subscription.cancellationNoticeWarning",{days:s.cancellation_notice_period})]})]}),l.jsxs("div",{className:"flex gap-2",children:[l.jsx(p,{size:"sm",variant:"outline",children:e("subscription.review")}),!s.auto_renewal&&l.jsx(p,{size:"sm",children:e("subscription.renew")})]})]})},s.id)}),0===$.length&&l.jsx("p",{className:"text-center text-muted-foreground py-8",children:e("subscription.noUpcomingRenewals")})]})})]})}),l.jsx(P,{value:"settings",className:"space-y-4",children:l.jsxs(x,{children:[l.jsxs(h,{children:[l.jsx(j,{children:e("subscription.preferences")}),l.jsx(k,{children:e("subscription.preferencesDesc")})]}),l.jsxs(f,{className:"space-y-6",children:[l.jsxs("div",{className:"flex items-center justify-between",children:[l.jsxs(C,{htmlFor:"tracking-enabled",className:"flex flex-col space-y-1 cursor-pointer",children:[l.jsx("span",{children:e("subscription.enableTracking")}),l.jsx("span",{className:"text-sm font-normal text-muted-foreground",children:e("subscription.enableTrackingDesc")})]}),l.jsx(F,{id:"tracking-enabled",checked:null==A?void 0:A.tracking_enabled,onCheckedChange:e=>ie("tracking_enabled",e)})]}),l.jsxs("div",{className:"flex items-center justify-between",children:[l.jsxs(C,{htmlFor:"cost-optimization",className:"flex flex-col space-y-1 cursor-pointer",children:[l.jsx("span",{children:e("subscription.costOptimization")}),l.jsx("span",{className:"text-sm font-normal text-muted-foreground",children:e("subscription.costOptimizationDesc")})]}),l.jsx(F,{id:"cost-optimization",checked:null==A?void 0:A.cost_optimization_enabled,onCheckedChange:e=>ie("cost_optimization_enabled",e)})]}),l.jsxs("div",{className:"space-y-2",children:[l.jsx(C,{children:e("subscription.reminderPeriods")}),l.jsx("div",{className:"flex gap-2",children:null==A?void 0:A.default_reminder_days.map(s=>l.jsxs(D,{variant:"secondary",children:[s," ",e("subscription.daysBefore")]},s))})]})]})]})})]})]})};export{V as SubscriptionDashboard};
